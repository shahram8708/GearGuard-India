{% extends 'base.html' %}

{% block content %}
<section class="py-4 root-console">
  <div class="root-hero mb-4 position-relative overflow-hidden">
    <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
      <div>
        <div class="d-inline-flex align-items-center gap-2 text-uppercase eyebrow text-white-50">
          <span class="badge-dot bg-success"></span>
          <span>Root Command</span>
        </div>
        <div class="d-flex flex-wrap align-items-center gap-2 mt-1">
          <h1 class="h3 mb-0 text-white">Platform Intelligence & Control</h1>
          <span class="badge border border-light text-white bg-transparent rounded-pill">Founder View</span>
        </div>
        <p class="text-white-75 mb-3">Enterprise-grade telemetry across tenants, revenue, risk, and reliability.</p>
        <div class="d-flex flex-wrap gap-2">
          <span class="chip-soft text-white border border-white-25"><i class="bi bi-shield-lock-fill me-2 text-success"></i>Super Admin</span>
          <span class="chip-soft text-white border border-white-25"><i class="bi bi-buildings me-2"></i>{{ org_count }} orgs</span>
          <span class="chip-soft text-white border border-white-25"><i class="bi bi-people me-2"></i>{{ total_users }} users</span>
          <span class="chip-soft text-white border border-white-25"><i class="bi bi-activity me-2"></i>{{ maintenance_overview.get('in_progress', 0) + maintenance_overview.get('new', 0) }} live work</span>
        </div>
      </div>
      <div class="d-flex flex-column align-items-end gap-2 text-end">
        <a class="btn btn-gradient btn-lg px-4 shadow-soft" href="{{ url_for('super_admin.security_center') }}"><i class="bi bi-activity me-2"></i>Security Center</a>
        <div class="text-white-75 small d-flex align-items-center gap-2">
          <i class="bi bi-lock-fill text-success"></i>
          <span>Audit-grade · Tenant isolated</span>
        </div>
      </div>
    </div>

    <div class="row g-3 g-md-4 mt-3">
      <div class="col-6 col-xl-3">
        <div class="root-metric">
          <div class="d-flex align-items-center justify-content-between">
            <div class="metric-icon bg-primary text-white"><i class="bi bi-buildings"></i></div>
            <span class="badge text-bg-dark border border-light-subtle">Org Health</span>
          </div>
          <div class="d-flex align-items-end gap-2 mt-2">
            <div class="display-6 fw-bold">{{ org_count }}</div>
            <div class="text-success small">{{ active_orgs }} active</div>
          </div>
          <div class="text-warning small">{{ suspended_orgs }} suspended</div>
        </div>
      </div>
      <div class="col-6 col-xl-3">
        <div class="root-metric">
          <div class="d-flex align-items-center justify-content-between">
            <div class="metric-icon bg-info text-white"><i class="bi bi-people"></i></div>
            <span class="badge text-bg-secondary border border-light-subtle">User Graph</span>
          </div>
          <div class="d-flex align-items-end gap-2 mt-2">
            <div class="display-6 fw-bold">{{ total_users }}</div>
            <div class="text-secondary small">{{ inactive_users }} inactive</div>
          </div>
          <div class="text-secondary small">Roles distributed across {{ role_mix.labels|length }} bands</div>
        </div>
      </div>
      <div class="col-6 col-xl-3">
        <div class="root-metric">
          <div class="d-flex align-items-center justify-content-between">
            <div class="metric-icon bg-success text-white"><i class="bi bi-cash-coin"></i></div>
            <span class="badge text-bg-success border border-light-subtle">Revenue</span>
          </div>
          <div class="d-flex align-items-end gap-2 mt-2">
            <div class="display-6 fw-bold">₹{{ '%.2f' % (captured_revenue / 100) }}</div>
            <div class="text-success small">Captured</div>
          </div>
          <div class="text-white-75 small">{{ payment_status_mix.get('created', {}).get('count', 0) }} awaiting · {{ payment_status_mix.get('failed', {}).get('count', 0) }} failed</div>
        </div>
      </div>
      <div class="col-6 col-xl-3">
        <div class="root-metric">
          <div class="d-flex align-items-center justify-content-between">
            <div class="metric-icon bg-danger text-white"><i class="bi bi-activity"></i></div>
            <span class="badge text-bg-danger border border-light-subtle">Reliability</span>
          </div>
          <div class="d-flex align-items-end gap-2 mt-2">
            <div class="display-6 fw-bold">{{ overdue_requests }}</div>
            <div class="text-danger small">Overdue</div>
          </div>
          <div class="text-white-75 small">{{ maintenance_overview.get('new', 0) }} new · {{ maintenance_overview.get('in_progress', 0) }} in progress</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 g-lg-4">
    <div class="col-lg-8">
      <div class="root-panel root-panel-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <div class="eyebrow text-uppercase text-white-50">Growth & Adoption</div>
            <h5 class="mb-0 text-white d-flex align-items-center gap-2"><i class="bi bi-graph-up"></i><span>Organizations vs Users</span></h5>
          </div>
        </div>
        <canvas id="orgUserGrowthChart" height="140"></canvas>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="root-panel root-panel-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <div class="eyebrow text-uppercase text-white-50">Subscription Mix</div>
            <h5 class="mb-0 text-white d-flex align-items-center gap-2"><i class="bi bi-grid"></i><span>Trial · Active · Expired</span></h5>
          </div>
        </div>
        <canvas id="subscriptionChart" height="180"></canvas>
        <div class="text-secondary small mt-2">Seat saturation avg: {{ avg_saturation * 100 }}%</div>
      </div>
    </div>
  </div>

  <div class="row g-3 g-lg-4 mt-3">
    <div class="col-xl-6">
      <div class="root-panel root-panel-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <div class="eyebrow text-uppercase text-white-50">Work Execution</div>
            <h5 class="mb-0 text-white d-flex align-items-center gap-2"><i class="bi bi-kanban"></i><span>Maintenance Trend</span></h5>
          </div>
        </div>
        <canvas id="maintenanceTrendChart" height="200"></canvas>
      </div>
    </div>
    <div class="col-xl-3">
      <div class="root-panel root-panel-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <div class="eyebrow text-uppercase text-white-50">Request Mix</div>
            <h5 class="mb-0 text-white d-flex align-items-center gap-2"><i class="bi bi-diagram-3"></i><span>Preventive vs Corrective</span></h5>
          </div>
        </div>
        <canvas id="requestTypeChart" height="180"></canvas>
      </div>
    </div>
    <div class="col-xl-3">
      <div class="root-panel root-panel-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <div class="eyebrow text-uppercase text-white-50">Seat Utilization</div>
            <h5 class="mb-0 text-white d-flex align-items-center gap-2"><i class="bi bi-people-fill"></i><span>Top Saturated Orgs</span></h5>
          </div>
        </div>
        {% if seat_utilization %}
          <div class="list-group list-group-flush">
            {% for item in seat_utilization %}
            <div class="list-group-item bg-transparent text-white d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-semibold">{{ item.organization }}</div>
                <div class="text-secondary small">{{ item.users }} / {{ item.capacity }} seats</div>
              </div>
              <span class="badge text-bg-{{ 'danger' if item.utilization >= 1 else 'info' }}">{{ (item.utilization * 100)|round(1) }}%</span>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty-state text-center py-4">
            <div class="icon-circle bg-white-10 mb-2"><i class="bi bi-people"></i></div>
            <div class="fw-semibold text-white">No utilization data yet.</div>
            <div class="text-secondary small">Seats will populate as orgs onboard.</div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="row g-3 g-lg-4 mt-3">
    <div class="col-xl-5">
      <div class="root-panel root-panel-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <div class="eyebrow text-uppercase text-white-50">Security Posture</div>
            <h5 class="mb-0 text-white d-flex align-items-center gap-2"><i class="bi bi-shield-lock"></i><span>Last 30 days</span></h5>
          </div>
          <a class="btn btn-sm btn-outline-light" href="{{ url_for('super_admin.security_center') }}"><i class="bi bi-box-arrow-up-right"></i></a>
        </div>
        <canvas id="securityChart" height="180"></canvas>
        <div class="list-group list-group-flush mt-3">
          {% for event_type, count in top_security_events %}
          <div class="list-group-item bg-transparent text-white d-flex justify-content-between align-items-center">
            <span class="text-capitalize">{{ event_type.replace('_', ' ') }}</span>
            <span class="badge text-bg-secondary">{{ count }}</span>
          </div>
          {% endfor %}
          {% if not top_security_events %}
          <div class="empty-state text-center py-4">
            <div class="icon-circle bg-white-10 mb-2"><i class="bi bi-shield-check"></i></div>
            <div class="fw-semibold text-white">No security signals</div>
            <div class="text-secondary small">Monitoring is live.</div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-xl-7">
      <div class="root-panel root-panel-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <div class="eyebrow text-uppercase text-white-50">Revenue & Risk</div>
            <h5 class="mb-0 text-white d-flex align-items-center gap-2"><i class="bi bi-credit-card-2-front"></i><span>Cashflow Trend</span></h5>
          </div>
        </div>
        <canvas id="revenueTrendChart" height="160"></canvas>
        <canvas id="paymentStatusChart" height="120" class="mt-3"></canvas>
        <div class="list-group list-group-flush mt-3">
          {% if failed_payments %}
            {% for payment in failed_payments %}
            <div class="list-group-item bg-transparent text-white d-flex flex-column gap-1">
              <div class="d-flex align-items-center justify-content-between">
                <div class="fw-semibold">Order {{ payment.razorpay_order_id }}</div>
                <span class="badge text-bg-warning">Failed</span>
              </div>
              <div class="text-secondary small">Org {{ payment.organization.name if payment.organization else 'n/a' }} · ₹{{ '%.2f' % (payment.amount/100) }} {{ payment.currency }}</div>
            </div>
            {% endfor %}
          {% else %}
            <div class="empty-state text-center py-3">
              <div class="icon-circle bg-white-10 mb-2"><i class="bi bi-check-circle"></i></div>
              <div class="fw-semibold text-white">No failed payments</div>
              <div class="text-secondary small">Billing stream is healthy.</div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 g-lg-4 mt-3">
    <div class="col-xl-6">
      <div class="root-panel root-panel-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <div class="eyebrow text-uppercase text-white-50">Feature Adoption</div>
            <h5 class="mb-0 text-white d-flex align-items-center gap-2"><i class="bi bi-diagram-3"></i><span>Equipment Coverage</span></h5>
          </div>
        </div>
        <canvas id="equipmentChart" height="180"></canvas>
      </div>
    </div>
    <div class="col-xl-6">
      <div class="root-panel root-panel-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <div class="eyebrow text-uppercase text-white-50">Support Intelligence</div>
            <h5 class="mb-0 text-white d-flex align-items-center gap-2"><i class="bi bi-life-preserver"></i><span>Request Categories</span></h5>
          </div>
        </div>
        <canvas id="supportChart" height="180"></canvas>
      </div>
    </div>
  </div>

  <div class="row g-3 g-lg-4 mt-3">
    <div class="col-lg-8">
      <div class="root-panel root-panel-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <div class="eyebrow text-uppercase text-white-50">Security Feed</div>
            <h5 class="mb-0 text-white d-flex align-items-center gap-2"><i class="bi bi-activity"></i><span>Live Security & Governance Events</span></h5>
          </div>
          <a class="btn btn-sm btn-outline-light" href="{{ url_for('super_admin.security_center') }}"><i class="bi bi-shield-check me-1"></i>Security Center</a>
        </div>
        {% if security_events %}
        <div class="list-group list-group-flush root-feed">
          {% for event in security_events %}
          <div class="list-group-item bg-transparent text-white d-flex align-items-start gap-3">
            <div class="feed-dot {{ 'bg-danger' if event.severity in ['critical','high'] else 'bg-secondary' }}"></div>
            <div class="flex-grow-1">
              <div class="d-flex flex-wrap align-items-center gap-2">
                <div class="fw-semibold text-capitalize">{{ event.event_type.replace('_', ' ') }}</div>
                <span class="badge feed-pill text-bg-{{ 'danger' if event.severity in ['critical','high'] else 'secondary' }}">{{ event.severity }}</span>
              </div>
              <div class="text-secondary small">{{ event.created_at.strftime('%Y-%m-%d %H:%M') }} · {{ event.actor_email or 'system' }} · {{ event.ip_address or 'n/a' }}</div>
            </div>
            <i class="bi bi-chevron-right text-secondary"></i>
          </div>
          {% endfor %}
        </div>
        {% else %}
          <div class="empty-state text-center py-4">
            <div class="icon-circle bg-white-10 mb-2"><i class="bi bi-shield-check"></i></div>
            <div class="fw-semibold text-white">No security events recorded yet.</div>
            <div class="text-secondary small">Live monitoring will appear here.</div>
          </div>
        {% endif %}
      </div>
    </div>
    <div class="col-lg-4">
      <div class="root-panel root-panel-elevated h-100">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <div class="eyebrow text-uppercase text-white-50">Top Activity</div>
            <h5 class="mb-0 text-white d-flex align-items-center gap-2"><i class="bi bi-bar-chart"></i><span>Most Active Organizations</span></h5>
          </div>
        </div>
        {% if top_orgs %}
          <div class="list-group list-group-flush">
            {% for org, user_count in top_orgs %}
            <div class="list-group-item bg-transparent text-white d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-semibold">{{ org.name }}</div>
                <div class="text-secondary small">Slug: {{ org.slug }}</div>
              </div>
              <span class="badge text-bg-info">{{ user_count }} users</span>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty-state text-center py-4">
            <div class="icon-circle bg-white-10 mb-2"><i class="bi bi-diagram-3"></i></div>
            <div class="fw-semibold text-white">No org data yet.</div>
            <div class="text-secondary small">Activity will appear once usage begins.</div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const palette = [
    '#6366f1', '#0ea5e9', '#22c55e', '#f97316', '#f43f5e', '#14b8a6', '#a855f7', '#eab308', '#64748b'
  ];

  const orgGrowth = {{ org_growth|tojson }} || { labels: [], values: [] };
  const userGrowth = {{ user_growth|tojson }} || { labels: [], values: [] };
  const subscriptionOverview = {{ subscription_overview|tojson }} || {};
  const requestTypeMix = {{ request_type_mix|tojson }} || { labels: [], values: [] };
  const maintenanceTrend = {{ maintenance_trend|tojson }} || { labels: [], datasets: {} };
  const securitySeverityMix = {{ security_severity_mix|tojson }} || { labels: [], values: [] };
  const revenueTrend = {{ revenue_trend|tojson }} || { labels: [], values: [] };
  const paymentStatusMix = {{ payment_status_mix|tojson }} || {};
  const equipmentMix = {{ equipment_mix|tojson }} || { labels: [], values: [] };
  const supportMix = {{ support_mix|tojson }} || { labels: [], values: [] };

  const getCtx = (id) => {
    const el = document.getElementById(id);
    return el ? el.getContext('2d') : null;
  };

  const safeValues = (arr) => Array.isArray(arr) ? arr : [];
  const ensureData = (labels = [], values = []) => {
    const safeLabels = safeValues(labels);
    const safeVals = safeValues(values);
    if (!safeLabels.length && !safeVals.length) {
      return { labels: ['No data'], values: [0] };
    }
    const size = Math.max(safeLabels.length, safeVals.length);
    const paddedLabels = [...safeLabels];
    const paddedVals = [...safeVals];
    while (paddedLabels.length < size) paddedLabels.push(`P${paddedLabels.length + 1}`);
    while (paddedVals.length < size) paddedVals.push(0);
    return { labels: paddedLabels, values: paddedVals };
  };

  const orgCtx = getCtx('orgUserGrowthChart');
  if (orgCtx) {
    const orgSeries = ensureData(orgGrowth.labels, orgGrowth.values);
    const userSeries = ensureData(userGrowth.labels, userGrowth.values);
    new Chart(orgCtx, {
      type: 'line',
      data: {
        labels: orgSeries.labels,
        datasets: [
          { label: 'Organizations', data: orgSeries.values, borderColor: palette[0], backgroundColor: 'rgba(99,102,241,0.15)', tension: 0.35, fill: true },
          { label: 'Users', data: userSeries.values, borderColor: palette[1], backgroundColor: 'rgba(14,165,233,0.15)', tension: 0.35, fill: true }
        ]
      },
      options: { plugins: { legend: { labels: { color: '#cbd5e1' } } }, scales: { x: { ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' } } } }
    });
  }

  const subCtx = getCtx('subscriptionChart');
  if (subCtx) {
    const subLabels = Object.keys(subscriptionOverview || {});
    const safeSubLabels = subLabels.length ? subLabels : ['No data'];
    const safeSubValues = subLabels.length ? subLabels.map(k => subscriptionOverview[k] || 0) : [0];
    new Chart(subCtx, {
      type: 'doughnut',
      data: {
        labels: safeSubLabels,
        datasets: [{ data: safeSubValues, backgroundColor: [palette[2], palette[0], palette[4]] }]
      },
      options: { plugins: { legend: { position: 'bottom', labels: { color: '#cbd5e1' } } } }
    });
  }

  const maintCtx = getCtx('maintenanceTrendChart');
  if (maintCtx) {
    const datasets = Object.entries(maintenanceTrend.datasets || {}).map(([key, values], idx) => ({
      label: key.replace('_', ' ').toUpperCase(),
      data: safeValues(values),
      backgroundColor: palette[idx % palette.length],
      stack: 'status'
    }));
    const labels = safeValues(maintenanceTrend.labels);
    if (!labels.length || !datasets.length) {
      datasets.push({ label: 'No data', data: [0], backgroundColor: palette[7], stack: 'status' });
    }
    new Chart(maintCtx, {
      type: 'bar',
      data: {
        labels: labels.length ? labels : ['No data'],
        datasets
      },
      options: { plugins: { legend: { labels: { color: '#cbd5e1' } } }, scales: { x: { stacked: true, ticks: { color: '#94a3b8' } }, y: { stacked: true, ticks: { color: '#94a3b8' } } } }
    });
  }

  const reqCtx = getCtx('requestTypeChart');
  if (reqCtx) {
    const reqSeries = ensureData(requestTypeMix.labels, requestTypeMix.values);
    new Chart(reqCtx, {
      type: 'pie',
      data: { labels: reqSeries.labels, datasets: [{ data: reqSeries.values, backgroundColor: [palette[3], palette[5]] }] },
      options: { plugins: { legend: { position: 'bottom', labels: { color: '#cbd5e1' } } } }
    });
  }

  const secCtx = getCtx('securityChart');
  if (secCtx) {
    new Chart(secCtx, {
      type: 'bar',
      data: { labels: safeValues(securitySeverityMix.labels).length ? safeValues(securitySeverityMix.labels) : ['No data'], datasets: [{ data: safeValues(securitySeverityMix.values).length ? safeValues(securitySeverityMix.values) : [0], backgroundColor: palette.slice(0, (securitySeverityMix.labels || []).length || 1) }] },
      options: { plugins: { legend: { display: false }, title: { display: false } }, scales: { x: { ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' } } } }
    });
  }

  const revCtx = getCtx('revenueTrendChart');
  if (revCtx) {
    const revSeries = ensureData(revenueTrend.labels, revenueTrend.values);
    new Chart(revCtx, {
      type: 'line',
      data: { labels: revSeries.labels, datasets: [{ label: 'Captured (₹)', data: revSeries.values.map(v => (v || 0) / 100), borderColor: palette[6], backgroundColor: 'rgba(168,85,247,0.18)', tension: 0.35, fill: true }] },
      options: { plugins: { legend: { labels: { color: '#cbd5e1' } } }, scales: { x: { ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' } } } }
    });
  }

  const payCtx = getCtx('paymentStatusChart');
  if (payCtx) {
    const payLabels = Object.keys(paymentStatusMix || {});
    const payValues = payLabels.length ? payLabels.map(k => paymentStatusMix[k] || {}) : [{ count: 0, amount: 0 }];
    const labels = payLabels.length ? payLabels : ['No data'];
    new Chart(payCtx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Count', data: payValues.map(v => v.count || 0), backgroundColor: palette[1] },
          { label: 'Amount (₹)', data: payValues.map(v => (v.amount || 0) / 100), backgroundColor: palette[4] }
        ]
      },
      options: { plugins: { legend: { labels: { color: '#cbd5e1' } } }, scales: { x: { ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' } } } }
    });
  }

  const equipCtx = getCtx('equipmentChart');
  if (equipCtx) {
    const eqSeries = ensureData(equipmentMix.labels, equipmentMix.values);
    new Chart(equipCtx, {
      type: 'bar',
      data: { labels: eqSeries.labels, datasets: [{ label: 'Equipment', data: eqSeries.values, backgroundColor: palette[0] }] },
      options: { plugins: { legend: { labels: { color: '#cbd5e1' } } }, scales: { x: { ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' } } } }
    });
  }

  const supportCtx = getCtx('supportChart');
  if (supportCtx) {
    const supSeries = ensureData(supportMix.labels, supportMix.values);
    new Chart(supportCtx, {
      type: 'doughnut',
      data: { labels: supSeries.labels, datasets: [{ data: supSeries.values, backgroundColor: palette }] },
      options: { plugins: { legend: { position: 'bottom', labels: { color: '#cbd5e1' } } } }
    });
  }
</script>
{% endblock %}
